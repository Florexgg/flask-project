{% extends "base.html" %}

{% block title %}–ü—Ä–∞–≤–∏–ª–∞{% endblock %}

{% block content %}
<button id="prev">–ù–∞–∑–∞–¥</button>
<button id="next">–í–ø–µ—Ä–µ–¥</button>

<div id="rules-container">
  <section class="rule" id="rule1">
    <strong>–ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–∏—à–∏–Ω–≥?</strong>
    <p>–§–∏—à–∏–Ω–≥ ‚Äî —ç—Ç–æ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∏ –ø—ã—Ç–∞—é—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ.</p>
    <div class="tooltip">–§–∏—à–∏–Ω–≥ ‚Äî –ø–æ–ø—ã—Ç–∫–∞ –≤—ã–º–∞–Ω–∏—Ç—å —É –≤–∞—Å –ª–æ–≥–∏–Ω, –ø–∞—Ä–æ–ª—å –∏–ª–∏ –¥–µ–Ω—å–≥–∏.</div>
  </section>
  <section class="rule" id="rule2">
    <strong>–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å?</strong>
    <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –ø–∞—Ä–æ–ª–∏ —Å —Ü–∏—Ñ—Ä–∞–º–∏, –±—É–∫–≤–∞–º–∏ –∏ —Å–∏–º–≤–æ–ª–∞–º–∏.</p>
    <div class="tooltip">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–º –∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º!</div>
  </section>
  <section class="rule" id="rule3">
    <strong>–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –ø–æ–¥–æ–∑—Ä–µ–Ω–∏–∏ –Ω–∞ –≤–∑–ª–æ–º?</strong>
    <p>–°–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª–∏, –≤–∫–ª—é—á–∏—Ç–µ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–∞ –≤–∏—Ä—É—Å—ã.</p>
    <div class="tooltip">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî –≤–∞—à–∞ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å!</div>
  </section>
</div>

  <script>
  const rulesrules = document.querySelectorAll('.rule');
  let currentIndex = 0;

  function showRule(index) {
    rules.forEach((rule, i) => {
      rule.style.display = i === index ? 'block' : 'none';
    });
  }

  document.getElementById('prev').onclick = () => {
    currentIndex = (currentIndex - 1 + rules.length) % rules.length;
    showRule(currentIndex);
  };

  document.getElementById('next').onclick = () => {
    currentIndex = (currentIndex + 1) % rules.length;
    showRule(currentIndex);
  };

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  showRule(currentIndex);
</script>

  <div id="progress-bar-container" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –∏–∑—É—á–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª">
    <div id="progress-bar"></div>
  </div>
  <div id="medal">üèÖ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –∏–∑—É—á–∏–ª–∏ –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞!</div>
  


  <div id="chat-container">
    <h3>–ß–∞—Ç-–±–æ—Ç –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h3>
    <div id="chat-log"></div>
    <input type="text" id="chat-input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å..." autocomplete="off" />
    <button id="chat-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>

  <style>
    /* –í—Å—Ç–∞–≤—å —Å—é–¥–∞ CSS –∏–∑ —Ç–≤–æ–µ–≥–æ –±–æ–ª—å—à–æ–≥–æ —Ñ–∞–π–ª–∞ */
    section.rule {
      background: linear-gradient(135deg, #333333, #555555);
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 15px;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.3s;
      position: relative;
    }
    section.rule:hover {
      background-color: #666666;
    }
    section.rule .tooltip {
      position: absolute;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      background: #717171cc;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.85em;
      display: none;
      max-width: 200px;
    }
    section.rule:hover .tooltip {
      display: block;
    }
    #progress-bar-container {
      width: 100%;
      background: #222;
      border-radius: 10px;
      overflow: hidden;
      margin: 20px 0;
      height: 20px;
    }
    #progress-bar {
      height: 100%;
      width: 0;
      background: #88cc88;
      transition: width 0.4s ease;
    }
    #medal {
      margin-top: 10px;
      font-size: 1.4em;
      color: gold;
      display: none;
      user-select: none;
    }
    #chat-container {
      margin-top: 30px;
      background: linear-gradient(135deg, #222222, #444444);
      border-radius: 6px;
      padding: 15px;
      width: 100%;
      max-width: 700px;
      color: #e0e0e0;
      font-size: 0.95em;
    }
    #chat-log {
      height: 150px;
      overflow-y: auto;
      background: #111;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .chat-message {
      margin-bottom: 8px;
    }
    .chat-message.user {
      color: #88ccff;
    }
    .chat-message.bot {
      color: #ccff88;
    }
    #chat-input {
      width: calc(100% - 90px);
      padding: 8px;
      border-radius: 4px;
      border: none;
      outline: none;
      font-size: 1em;
    }
    #chat-send {
      width: 70px;
      padding: 8px;
      margin-left: 10px;
      border-radius: 4px;
      border: none;
      background: #444;
      color: #eee;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #chat-send:hover {
      background: #666;
    }
    nav {
      margin-top: 20px;
      text-align: center;
    }
    nav button {
      background: linear-gradient(to bottom, #888888, #555555);
      color: #f0f0f0;
      padding: 10px 15px;
      border: none;
      margin: 5px;
      cursor: pointer;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      font-size: 1em;
      min-width: 140px;
      transition: background-color 0.3s;
    }
    nav button:hover {
      background: linear-gradient(to bottom, #aaaaaa, #777777);
    }
  </style>


  <script>
  // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  async function getAIResponse(message) {
    try {
      const response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      const data = await response.json();
      return data.reply;
    } catch {
      return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.";
    }
  }

  const chatLog = document.getElementById('chat-log');
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');

  function addMessage(text, sender) {
    const div = document.createElement('div');
    div.classList.add('chat-message', sender);
    div.textContent = text;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  chatSend.addEventListener('click', async () => {
    const userMessage = chatInput.value.trim();
    if (!userMessage) return;
    addMessage(userMessage, 'user');
    chatInput.value = '';
    chatInput.focus();

    const botReply = await getAIResponse(userMessage);
    addMessage(botReply, 'bot');
  });

  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      chatSend.click();
    }
  });

  // –û—Å—Ç–∞–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—á—Ç–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª
  const rules = document.querySelectorAll('section.rule');
  const progressBar = document.getElementById('progress-bar');
  const medal = document.getElementById('medal');

  function updateProgress() {
    let readCount = 0;
    rules.forEach(rule => {
      if (rule.dataset.read === "true") readCount++;
    });
    const progressPercent = (readCount / rules.length) * 100;
    progressBar.style.width = progressPercent + '%';

    if (readCount === rules.length) {
      medal.style.display = 'block';
    }
  }

  rules.forEach(rule => {
    rule.addEventListener('click', () => {
      if (rule.dataset.read === "false") {
        rule.dataset.read = "true";
        updateProgress();
      }
    });
  });
</script>
{% endblock %}
